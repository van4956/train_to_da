
Что делает данный запрос?

```
WITH ltv AS (
  SELECT user_id, SUM(amount) AS lifetime_value
  FROM payments
  GROUP BY 1
),
scored AS (
  SELECT user_id,
         lifetime_value,
         NTILE(4) OVER (ORDER BY lifetime_value) AS quartile
  FROM ltv
)
SELECT quartile,
       AVG(lifetime_value) AS avg_ltv,
       SUM(lifetime_value) / NULLIF(COUNT(*), 0) AS arpu
FROM scored
GROUP BY 1
ORDER BY 1;
```

---

Считает LTV каждого пользователя. Делит пользователей на 4 квартиля по LTV. Считает метрики по каждому квартилю. ARPU (Average Revenue Per User) — средний доход на одного пользователя за период. В данном запросе ARPU = AVG LTV, потому что и числитель, и знаменатель агрегированы только по пользователям за весь lifetime. В реальных кейсах ARPU обычно считают за фиксированный период, поэтому он отличается от LTV.

---

#lvl_2 