
Что делает данный запрос со скользящим окном и как он используется для поиска аномалий?

```sql
WITH monthly AS (
  SELECT 
	  DATE_TRUNC('month', event_time) AS month,
	  COUNT(DISTINCT user_id) AS mau
  FROM events
  GROUP BY 1
),
stats AS (
  SELECT 
	  month,
	  mau,
      AVG(mau) OVER (ORDER BY month ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS mean_mau,
	  STDDEV_SAMP(mau) OVER (ORDER BY month ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS std_mau
  FROM monthly
)
SELECT 
	month,
    mau,
    (mau - mean_mau) / NULLIF(std_mau, 0) AS z_score
FROM stats;
```

---

Запрос считает MAU по месяцам, затем для каждого месяца вычисляет скользящее среднее и стандартное отклонение за последние 3 месяца. На основе этих значений рассчитывается z-score, который показывает, насколько текущий MAU отклоняется от недавнего тренда и помогает выявлять аномалии.

---

#lvl_3 