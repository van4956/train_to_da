
Что вычисляет данный запрос? 

```sql
WITH funnel AS (
  SELECT
	  user_id,
	  MAX(event_time) FILTER (WHERE event_name = 'apply') AS applied,
      MAX(event_time) FILTER (WHERE event_name = 'approved') AS approved,
      MAX(event_time) FILTER (WHERE event_name = 'funded') AS funded
  FROM credit_events
  GROUP BY user_id
)
SELECT
  COUNT(*) AS applicants,
  COUNT(*) FILTER (WHERE approved IS NOT NULL) AS approvals,
  COUNT(*) FILTER (WHERE funded IS NOT NULL) AS funded_cnt,
  COUNT(*) FILTER (WHERE approved IS NOT NULL)::float / COUNT(*) AS approve_rate,
  COUNT(*) FILTER (WHERE funded IS NOT NULL)::float / COUNT(*) AS fund_rate
FROM funnel;
```

---

Данный запрос вычисляет кумулятивную конверсию кредитной воронки, строит трёхшаговую воронку и выводит абсолютные и относительные показатели для каждой ступени благодаря FILTER.

---

#lvl_3 